#
# Basic yaml code to get the ESP32-E32R28T (LCDWiki 2.8" ESP32-32E) working in Home Assistant as a 12-button "Stream Deck"
# ============================================================
# Author: Aaron Stewart @makeitworktech, with the help of ChatGPT.
# GitHub: https://github.com/makeitworktech
# Product Info: https://www.lcdwiki.com/2.8inch_ESP32-32E_Display
# ============================================================ 
# NOTE:
# In order for this to work you need to add the following settings in your secrets.yaml file:
# - api_key
# - ota_password
# - wifi_ssid
# - wifi_password
# - ap_password
#
# Create a folder named fonts in your ESPHome folder, and copy the 
# files fonts/Arimo-Regular.ttf and fonts/materialdesignicons-webfont.ttf there.
#
# ============================================================ 
# General ESPHome Setup
# ============================================================
# Change the naming below, they will be the names used in Home Assistant
# ESPHome naming
esphome:
  name: esp32-e32r28t                           # Device hostname
  friendly_name: ESP32-CYD 2.8in E32R28T        # Friendly name shown in Home Assistant

# The ESP32-E32R28T/ESP32-32E uses a standard ESP32-WROVER, so we use esp32dev
esp32:
  board: esp32dev
  framework:
    type: arduino

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key

# Set OTA password, enables updates via ESPHome
ota:
  platform: esphome
  password: !secret ota_password

# Setup WiFi credentials, references the wifi ssid and pass in secrets.yaml
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot in case wifi connection fails
  ap:
    ssid: $device_name Fallback Hotspot
    password: !secret ap_password

# Allows captive portal access when in fallback mode
captive_portal:

# ============================================================ 
# ESPHome Display related setup
# ============================================================
# Create a font to use, add and remove glyphs as needed. 
font:
  - file:
      path: fonts/Arimo-Regular.ttf  # Path to main font file
      type: local
    id: arimo48
    size: 42
    glyphs:
      - " .,°0123456789CF"
  - file:
      path: fonts/Arimo-Regular.ttf
      type: local
    id: arimo14
    size: 14
    glyphs:
      - "0123456789"
  - file: fonts/materialdesignicons-webfont.ttf
    id: font_mdi
    size: 45
    glyphs:
      - "󰏘"
      - "󱁑"
      - "󰤝"
      - "󰈐"
      - "󱩋"
      - "󰠝"
      - "󱟉"

# Per-button customizable colors
color:
  # background color
  - id: room_bg_color
    hex: "000000"
  # button background color
  - id: default_button_bg_color
    hex: "000000"
  # button pressed background color
  - id: default_button_pressed_bg_color
    hex: "D3D3D3"
  # button text colors
  - id: btn_1_txt_color
    hex: FF0000
  - id: btn_2_txt_color
    hex: FF7F00
  - id: btn_3_txt_color
    hex: FFFF00
  - id: btn_4_txt_color
    hex: 00FF00
  - id: btn_5_txt_color
    hex: FF1493
  - id: btn_6_txt_color
    hex: 800080
  - id: btn_7_txt_color
    hex: 0000FF
  - id: btn_8_txt_color
    hex: 00FFFF
  - id: btn_9_txt_color
    hex: FFFFFF
  - id: btn_10_txt_color
    hex: FFFFFF
  - id: btn_11_txt_color
    hex: FFFFFF
  - id: btn_12_txt_color
    hex: FFFFFF

# ============================================================ 
# Home Assistant related setup
# ============================================================

# Setting the single channel backlight as a light entity in Home Assistant
light:
  - platform: monochromatic
    output: backlight_pwm
    name: Display Backlight
    id: backlight
    restore_mode: ALWAYS_ON

# 12 virtual button presses exposed as binary_sensors
binary_sensor:
  - platform: template
    name: Button 1
    id: button_1_pressed
  - platform: template
    name: Button 2
    id: button_2_pressed
  - platform: template
    name: Button 3
    id: button_3_pressed
  - platform: template
    name: Button 4
    id: button_4_pressed
  - platform: template
    name: Button 5
    id: button_5_pressed
  - platform: template
    name: Button 6
    id: button_6_pressed
  - platform: template
    name: Button 7
    id: button_7_pressed
  - platform: template
    name: Button 8
    id: button_8_pressed
  - platform: template
    name: Button 9
    id: button_9_pressed
  - platform: template
    name: Button 10
    id: button_10_pressed
  - platform: template
    name: Button 11
    id: button_11_pressed
  - platform: template
    name: Button 12
    id: button_12_pressed

# Mirror HA entity states for buttons 10-12 and keep icons/state in sync
text_sensor:
  - platform: homeassistant
    id: ts_office_ambient
    entity_id: light.office_ambient_lights
    on_value:
      then:
        - lvgl.widget.update:
            id: btn_10
            state:
              checked: !lambda return (0 == x.compare(std::string{"on"}));
              disabled: !lambda return ((0 == x.compare(std::string{"unavailable"})) or (0 == x.compare(std::string{"unknown"})));
        - lvgl.label.update:
            id: lbl_btn_10
            text: !lambda |-
              static char buf[10];
              std::string icon;
              if (0 == x.compare(std::string{"on"})) {
                  icon = "󱁑";
              } else {
                  icon = "󱩋";
              }
              snprintf(buf, sizeof(buf), "%s", icon.c_str());
              return buf;

  - platform: homeassistant
    id: ts_office_fan_plug
    entity_id: switch.office_fan_plug
    on_value:
      then:
        - lvgl.widget.update:
            id: btn_11
            state:
              checked: !lambda return (0 == x.compare(std::string{"on"}));
              disabled: !lambda return ((0 == x.compare(std::string{"unavailable"})) or (0 == x.compare(std::string{"unknown"})));
        - lvgl.label.update:
            id: lbl_btn_11
            text: !lambda |-
              static char buf[10];
              std::string icon;
              if (0 == x.compare(std::string{"on"})) {
                  icon = "󰈐";
              } else {
                  icon = "󰠝";
              }
              snprintf(buf, sizeof(buf), "%s", icon.c_str());
              return buf;

  - platform: homeassistant
    id: ts_office_light
    entity_id: light.office_light
    on_value:
      then:
        - lvgl.widget.update:
            id: btn_12
            state:
              checked: !lambda return (0 == x.compare(std::string{"on"}));
              disabled: !lambda return ((0 == x.compare(std::string{"unavailable"})) or (0 == x.compare(std::string{"unknown"})));
        - lvgl.label.update:
            id: lbl_btn_12
            text: !lambda |-
              static char buf[10];
              std::string icon;
              if (0 == x.compare(std::string{"on"})) {
                  icon = "󰤝";
              } else {
                  icon = "󱟉";
              }
              snprintf(buf, sizeof(buf), "%s", icon.c_str());
              return buf;

# ============================================================ 
# Touchscreen + Display hardware setup
# ============================================================

# SPI bus for TFT display and touch controller (LCDWiki 2.8" common mapping)
spi:
  - id: tft
    clk_pin: GPIO14
    mosi_pin: GPIO13
    miso_pin: GPIO12
  - id: touch
    clk_pin: GPIO25
    mosi_pin: GPIO32
    miso_pin: GPIO39

# Backlight PWM
output:
  - platform: ledc
    pin: GPIO21
    id: backlight_pwm

# Touchscreen (XPT2046)
touchscreen:
  platform: xpt2046
  spi_id: touch
  cs_pin: GPIO33
  interrupt_pin: GPIO36
  update_interval: 50ms
  threshold: 400
  calibration:
    x_min: 180
    x_max: 3800
    y_min: 240
    y_max: 3860
  transform:
    swap_xy: true
  id: my_touch

# TFT Display (ILI9341)
display:
  - platform: ili9xxx
    id: my_display
    model: ili9341
    spi_id: tft
    dc_pin: GPIO2
    cs_pin: GPIO15
    reset_pin: GPIO4
    dimensions:
      width: 320
      height: 240
    color_palette: 8BIT
    invert_colors: false
    transform:
      swap_xy: true
    update_interval: never
    auto_clear_enabled: false
    show_test_card: false

# ============================================================ 
# LVGL UI (Theme + Buttons to match E32R35T behavior)
# ============================================================

lvgl:
  buffer_size: 25%
  displays:
    - my_display
  touchscreens:
    - my_touch
  page_wrap: false
  theme:
    button:
      # Match E32R35T theme exactly
      bg_color: 0x000000
      bg_opa: COVER
      border_color: 0x000000
      border_width: 1
      text_color: 0xFFFFFF
      pressed:
        bg_color: 0xC0C0C0
        bg_grad_color: 0xC0C0C0
        bg_opa: COVER
      checked:
        bg_color: 0x000000
        bg_grad_color: 0x000000
        bg_opa: COVER
        text_color: 0x800080  # purple icon when checked
  pages:
    - id: main_page
      pad_all: 0
      widgets:
        - obj:
            width: 320
            height: 240
            bg_color: room_bg_color
            layout:
              type: grid
              grid_columns: [fr(1), fr(1), fr(1), fr(1)]
              grid_rows: [fr(1), fr(1), fr(1)]
            pad_all: 5px
            outline_pad: 5px
            widgets:
              - button:
                  id: btn_1
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 0
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_1
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_1_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_1_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_1_pressed
                          state: OFF

              - button:
                  id: btn_2
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 0
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_2
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_2_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_2_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_2_pressed
                          state: OFF

              - button:
                  id: btn_3
                  grid_cell_column_pos: 2
                  grid_cell_row_pos: 0
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_3
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_3_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_3_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_3_pressed
                          state: OFF

              - button:
                  id: btn_4
                  grid_cell_column_pos: 3
                  grid_cell_row_pos: 0
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_4
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_4_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_4_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_4_pressed
                          state: OFF

              - button:
                  id: btn_5
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 1
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_5
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_5_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_5_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_5_pressed
                          state: OFF

              - button:
                  id: btn_6
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 1
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_6
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_6_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_6_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_6_pressed
                          state: OFF

              - button:
                  id: btn_7
                  grid_cell_column_pos: 2
                  grid_cell_row_pos: 1
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_7
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_7_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_7_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_7_pressed
                          state: OFF

              - button:
                  id: btn_8
                  grid_cell_column_pos: 3
                  grid_cell_row_pos: 1
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_8
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_8_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_8_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_8_pressed
                          state: OFF

              - button:
                  id: btn_9
                  grid_cell_column_pos: 0
                  grid_cell_row_pos: 2
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  pressed:
                    bg_color: default_button_pressed_bg_color
                  widgets:
                    - label:
                        id: lbl_btn_9
                        text: "󰏘"
                        text_font: font_mdi
                        text_color: btn_9_txt_color
                        align: center
                  on_click:
                    then:
                      - binary_sensor.template.publish:
                          id: button_9_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_9_pressed
                          state: OFF

              - button:
                  id: btn_10
                  grid_cell_column_pos: 1
                  grid_cell_row_pos: 2
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  checkable: true
                  widgets:
                    - label:
                        id: lbl_btn_10
                        text: "󱁑"
                        text_font: font_mdi
                        align: center
                  on_click:
                    then:
                      - homeassistant.action:
                          action: light.toggle
                          data:
                            entity_id: light.office_ambient_lights
                      - binary_sensor.template.publish:
                          id: button_10_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_10_pressed
                          state: OFF

              - button:
                  id: btn_11
                  grid_cell_column_pos: 2
                  grid_cell_row_pos: 2
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  checkable: true
                  widgets:
                    - label:
                        id: lbl_btn_11
                        text: "󰈐"
                        text_font: font_mdi
                        align: center
                  on_click:
                    then:
                      - homeassistant.action:
                          action: switch.toggle
                          data:
                            entity_id: switch.office_fan_plug
                      - binary_sensor.template.publish:
                          id: button_11_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_11_pressed
                          state: OFF

              - button:
                  id: btn_12
                  grid_cell_column_pos: 3
                  grid_cell_row_pos: 2
                  grid_cell_x_align: STRETCH
                  grid_cell_y_align: STRETCH
                  bg_color: default_button_bg_color
                  checkable: true
                  widgets:
                    - label:
                        id: lbl_btn_12
                        text: "󰤝"
                        text_font: font_mdi
                        align: center
                  on_click:
                    then:
                      - homeassistant.action:
                          action: light.toggle
                          data:
                            entity_id: light.office_light
                      - binary_sensor.template.publish:
                          id: button_12_pressed
                          state: ON
                      - delay: 500ms
                      - binary_sensor.template.publish:
                          id: button_12_pressed
                          state: OFF
